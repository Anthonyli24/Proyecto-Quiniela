--    // LOGIN Y REGISTRO \\


-- Procedimiento para validar login de usuario
CREATE PROCEDURE sp_ValidarLogin
    @nombre_usuario VARCHAR(50),
    @contraseña VARCHAR(100)
AS
BEGIN
    -- Variables para el resultado
    DECLARE @usuario_id INT
    DECLARE @nombre VARCHAR(100)
    DECLARE @correo VARCHAR(100)
    DECLARE @rol VARCHAR(50)
    DECLARE @estado VARCHAR(50)
    DECLARE @mensaje VARCHAR(200)

    -- Buscar el usuario con las credenciales proporcionadas
    SELECT
        @usuario_id = u.usuario_id,
        @nombre = u.nombre,
        @correo = u.correo,
        @rol = r.rol,
        @estado = u.estado
    FROM Usuario u
    INNER JOIN Rol r ON u.rol_id = r.rol_id
    WHERE u.nombre_usuario = @nombre_usuario
    AND u.contraseña = @contraseña

    -- Verificar el resultado
    IF @usuario_id IS NOT NULL
    BEGIN
        -- Verificar si el usuario está activo
        IF @estado = 'activo'
        BEGIN
            -- Login exitoso
            SET @mensaje = 'Login exitoso'
            SELECT
                1 as login_exitoso,
                @usuario_id as usuario_id,
                @nombre as nombre,
                @correo as correo,
                @rol as rol,
                @estado as estado,
                @mensaje as mensaje
        END
        ELSE
        BEGIN
            -- Usuario inactivo
            SET @mensaje = 'Usuario inactivo'
            SELECT
                0 as login_exitoso,
                NULL as usuario_id,
                NULL as nombre,
                NULL as correo,
                NULL as rol,
                @estado as estado,
                @mensaje as mensaje
        END
    END
    ELSE
    BEGIN
        -- Credenciales incorrectas
        SET @mensaje = 'Usuario o contraseña incorrectos'
        SELECT
            0 as login_exitoso,
            NULL as usuario_id,
            NULL as nombre,
            NULL as correo,
            NULL as rol,
            NULL as estado,
            @mensaje as mensaje
    END
END







--Procedimiento para registrar un usuario



CREATE PROCEDURE RegistrarUsuario
    @nombre VARCHAR(100),
    @correo VARCHAR(100),
    @nombre_usuario VARCHAR(50),
    @contraseña VARCHAR(100),
    @fecha_nacimiento DATE,
    @estado VARCHAR(50),
    @rol_id INT
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        -- Validar si ya existe el nombre de usuario o el correo
        IF EXISTS (SELECT 1 FROM Usuario WHERE nombre_usuario = @nombre_usuario OR correo = @correo)
        BEGIN
            THROW 50001, 'El nombre de usuario o correo ya están registrados.', 1;
        END

        -- Insertar el nuevo usuario
        INSERT INTO Usuario (nombre, correo, nombre_usuario, contraseña, fecha_nacimiento, estado, rol_id)
        VALUES (@nombre, @correo, @nombre_usuario, @contraseña, @fecha_nacimiento, @estado, @rol_id);

        PRINT 'Usuario registrado exitosamente.';
    END TRY
    BEGIN CATCH
        -- Manejo del error
        DECLARE @ErrorMessage NVARCHAR(4000);
        DECLARE @ErrorSeverity INT;
        DECLARE @ErrorState INT;

        SELECT
            @ErrorMessage = ERROR_MESSAGE(),
            @ErrorSeverity = ERROR_SEVERITY(),
            @ErrorState = ERROR_STATE();

        RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
    END CATCH
END;







--    // PROCEDIMIENTOS Y FUNCIONES ESPECIFICAS PARA  ADMINISTRADOR \\



-- Funcion para obtener los partidos

CREATE FUNCTION fn_ObtenerPartidos()
RETURNS TABLE
AS
RETURN
(
    SELECT * FROM Partido
);






--Procedimiento para Insertar partidos

CREATE PROCEDURE sp_InsertarPartido
           @FechaPartido DATE,
           @HoraPartido TIME,
           @EquipoLocal INT,
           @EquipoVisitante INT,
           @TorneoID INT
       AS
       BEGIN
           SET NOCOUNT ON;

           -- Validación 1: Fecha del partido no puede ser en el pasado
           IF @FechaPartido < CAST(GETDATE() AS DATE)
           BEGIN
               THROW 50001, 'La fecha del partido no puede estar en el pasado.', 1;
               RETURN;
           END

           -- Validación 2: Hora del partido no puede ser NULL
           IF @HoraPartido IS NULL
           BEGIN
               THROW 50002, 'La hora del partido es obligatoria.', 1;
               RETURN;
           END

           -- Validación 3: No se permiten equipos iguales
           IF @EquipoLocal = @EquipoVisitante
           BEGIN
               THROW 50003, 'El equipo local y visitante no pueden ser el mismo.', 1;
               RETURN;
           END

           -- Validación 4: Verificar que el torneo exista
           IF NOT EXISTS (SELECT 1 FROM Torneo WHERE torneo_id = @TorneoID)
           BEGIN
               THROW 50004, 'El torneo especificado no existe.', 1;
               RETURN;
           END

           -- Validación 5: Verificar que ambos equipos existan
           IF NOT EXISTS (SELECT 1 FROM Equipo WHERE equipo_id = @EquipoLocal)
           BEGIN
               THROW 50005, 'El equipo local no existe.', 1;
               RETURN;
           END

           IF NOT EXISTS (SELECT 1 FROM Equipo WHERE equipo_id = @EquipoVisitante)
           BEGIN
               THROW 50006, 'El equipo visitante no existe.', 1;
               RETURN;
           END

           -- Validación 6: El equipo local no debe tener otro partido ese día
           IF EXISTS (
               SELECT 1 FROM Partido
               WHERE fecha_partido = @FechaPartido
                 AND (equipo_local = @EquipoLocal OR equipo_visitante = @EquipoLocal)
           )
           BEGIN
               THROW 50007, 'El equipo local ya tiene un partido programado ese día.', 1;
               RETURN;
           END

           -- Validación 7: El equipo visitante no debe tener otro partido ese día
           IF EXISTS (
               SELECT 1 FROM Partido
               WHERE fecha_partido = @FechaPartido
                 AND (equipo_local = @EquipoVisitante OR equipo_visitante = @EquipoVisitante)
           )
           BEGIN
               THROW 50008, 'El equipo visitante ya tiene un partido programado ese día.', 1;
               RETURN;
           END

           -- Inserción del partido
           INSERT INTO Partido (
               estado_partido,
               goles_visitante,
               goles_local,
               fecha_partido,
               hora_partido,
               equipo_local,
               equipo_visitante,
               torneo_id
           )
           VALUES (
               'Pendiente',
               0,
               0,
               @FechaPartido,
               @HoraPartido,
               @EquipoLocal,
               @EquipoVisitante,
               @TorneoID
           );
       END;



